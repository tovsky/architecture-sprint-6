# architecture-sprint-6
## Exc3

## Текущие проблемы и риски, которые связаны с планируемым ростом нагрузки.
- Сервисы core-app и ins-comp-settlement синхронно запрашивают информацию ins-product-aggregator.
    ins-product-aggregator синхронно запрашивает информацию от всех страховых (сейчас 5, но будут новые подключения).
    Даже если ins-product-aggregator будет запрашивать информацию у страховых в многопоточном режиме, 
    то минимальное время ответ сервиса ins-product-aggregator это максимальное время ответа одной из страховых + доп время на агрегацию.
    В случае технического сбоя одной из страховых или долгого времени ответа, мы получаем сбои работы в сервисе ins-product-aggregator 
    и в запрашиваемых у него сервисах core-app и ins-comp-settlement.
    Проблемы с работой уже есть, и в случае увеличение количества подключенных страховых ситуации сбоев будут увеличиваться.
- Сервисы обращаются к ins-product-aggregator с разными интервалами времени: 1 раз в 15 минут, 1 раз в сутки.
  Это может приводить к неактуальной информации о предложениях от страховой.
- Дополнительно сервис ins-comp-settlement раз в сутки осуществляет запрос в core-app по REST API. 
    В случае увеличения количества оформленных страховок, в случае частично обработанной информации на стороне ins-comp-settlement, 
    будем получать увеличенную нагрузку и проблему с частично обработанной информацией о страховках, которую сложно отследить и правильно дополнить.

## Вывод
Хорошим решением будет внедренить Event-Driven архитектуру, например с использованием Kafka.

### Обновленная схема доступна по url
- https://drive.google.com/file/d/1LuujpSL-gozjrzHO_v7q3f7haqEYvz4O/view?usp=sharing


## Правки по результатам ревью:
> Не увидел как будет реализована логика обновления данных в ins-product-aggregator, как будем получать обновления, 
>   чтобы отправить сообщение?

В ins-product-aggregator стоит по крону (условно раз в 10 минут) реализовать запросы информации у страховых компаний.
Сейчас эта информация получается синхронно и в агрегированном виде отдается при каждом http запросе.
Можно реализовать независимое получение информации от каждой страховой и информацию об этом публиковать кафку.
Если при детальном изучении текущей реализации, потребуется публикация в агрегированном виде, 
  то это также возможно сделать (нужно смотреть на время/деньги для внедрения изменений).


> Для ins-product-aggregator Transaction-Outbox кажется будет усложением + накладные расходы + нам не 
> страшно потерять обновление тарифа/продукта, так как оно потсоянно происходит и если не в этот раз, то в слежующий обновим

Спасибо за обратную связь. Действительно будет ненужное усложнение.
Убрал запись об этом из ранее сделанных выводов.


> Для взаимодействия с core-app и ins-comp-settlement, так же стоит перейти на Event-driven подход, 
> так как сейчас есть пакетная синхронная зависимость, которая с ростом данных будет выполнятся дольше и дольше
> При переходе на Event-driven сможем сразу получать новые заявки на страховку и обрабатывать, без пакетного запроса
> Нужен ли здесь Transaction-Outbox?

Действительно, сейчас раз в сутки происходит синхронный запрос 
сервисом ins-comp-settlement  в core-app по REST API для получения всех оформленных за день страховок.
Более лучшим будет решением перевести на асинхронное взаимодействие путем публикации информации о каждой оформленной страховки в момент оформления.
И здесь так как эта информация в дальнейшем используется сервисом ins-comp-settlement для дальнейших взаиморасчетов со страховыми,
то очень верным видится использование Transaction-Outbox для гарантии публикации такой информации в Kafka.


### Итого после ревью.
На схему добавлены публикация/чтение запросов об оформеленных продуктах через Kafka.
Для ins-product-aggregator указано, что обращение в страховые происходит за информацией, происходит по расписанию.

### Обновленная схема доступна по той же ссылке, что и в первом коммите:
- https://drive.google.com/file/d/1LuujpSL-gozjrzHO_v7q3f7haqEYvz4O/view?usp=sharing
